name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

# OIDC settings
permissions:
  # This is required for requesting the OIDC token
  id-token: write
  # This is required for actions/checkout
  contents: read

jobs:
  test_build_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:
        # JFrog platform url (for example: https://acme.jfrog.io)
        JF_URL: https://soleng.jfrog.io 
      with:
        # Name of the OIDC provider as specified on the OIDC integration page in the JFrog Platform
        oidc-provider-name: tomokim-github-actions-integration 
        oidc-audience: tomokim-github-actions-integration
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
  
    - name: Configure Maven for Artifactory
      run: |
        # Configure Maven to use Artifactory virtual repository
        jf mvnc --repo-resolve-snapshots tomokim-dev-backend-maven-dev-virtual --repo-resolve-releases tomokim-dev-backend-maven-dev-virtual --repo-deploy-snapshots tomokim-dev-backend-maven-dev-local --repo-deploy-releases tomokim-dev-backend-maven-dev-local
        # Create minimal settings.xml to avoid security issues
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <settings>
          <servers>
            <server>
              <id>soleng.jfrog.io</id>
              <username>github-actions</username>
              <password>dummy</password>
            </server>
          </servers>
        </settings>
        EOF
       
    - name: Check JFrog connectivity
      run: |
        # Ping the server
        jf rt ping
        # Test remote repository access
        echo "Testing remote repository access..."
        jf rt search "tomokim-dev-backend-maven-dev-remote/*" --count
        jf rt search "tomokim-dev-backend-maven-dev-virtual/*" --count

    - name: Run tests and build project
      run: mvn clean package -X

    - name: Upload to Artifactory
      run: |
        # Upload JAR files to Artifactory local repository
        jf rt upload "target/*.jar" "tomokim-dev-backend-maven-dev-local/"
        # Publish build info
        jf rt bp
