name: CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

# OIDC settings
permissions:
  # This is required for requesting the OIDC token
  id-token: write
  # This is required for actions/checkout
  contents: read

jobs:
  test_build_publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:
        # JFrog platform url (for example: https://acme.jfrog.io)
        JF_URL: https://soleng.jfrog.io 
      with:
        # Name of the OIDC provider as specified on the OIDC integration page in the JFrog Platform
        oidc-provider-name: tomokim-github-actions-integration 
        oidc-audience: tomokim-github-actions-integration
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    #- name: Cache Maven dependencies
    #  uses: actions/cache@v4
    #  with:
    #    path: ~/.m2
    #    key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
    #    restore-keys: ${{ runner.os }}-m2
  
    - name: Set environment variables based on branch
      run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "REPO_ENV=prod" >> $GITHUB_ENV
          elif [[ "${{ github.ref_name }}" == "dev" ]]; then
            echo "REPO_ENV=dev" >> $GITHUB_ENV
          else
            echo "REPO_ENV=dev" >> $GITHUB_ENV
          fi
          echo "Repository environment: $REPO_ENV"

    - name: Configure Maven for Artifactory
      run: |
        # Configure Maven to use Artifactory virtual repository based on branch
        jf mvnc \
          --repo-resolve-snapshots tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-remote \
          --repo-resolve-releases tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-virtual \
          --repo-deploy-snapshots tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-local \
          --repo-deploy-releases tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-local
        
        # Create minimal settings.xml to avoid security issues
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <settings>
          <servers>
            <server>
              <id>soleng.jfrog.io</id>
              <username>github-actions</username>
              <password>dummy</password>
            </server>
          </servers>
        </settings>
        EOF
       
    - name: Check JFrog connectivity
      run: |
        # Ping the server
        jf rt ping
        # Test remote repository access
        echo "Testing remote repository access..."
        jf rt search "tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-remote/*" --count
        jf rt search "tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-virtual/*" --count

    - name: Run tests and build project
      run: |
        # purge local mave cache
        mvn dependency:purge-local-repository
        # test and build
        mvn clean package

    - name: Upload to Artifactory
      run: |
        # Upload JAR files to Artifactory local repository based on environment
        jf rt upload "target/*.jar" "tomokim-${{ env.REPO_ENV }}-backend-maven-${{ env.REPO_ENV }}-local/"
        # Publish build info
        jf rt bp
